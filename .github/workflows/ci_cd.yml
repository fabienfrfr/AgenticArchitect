name: CI-CD-Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: ${{ github.workspace }}
      ENV: test
      OLLAMA_URL: http://localhost:11434

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          # Wait for server to start
          sleep 5

      - name: Pull Test Model
        run: ollama pull gemma3:270m

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgirepository1.0-dev libcairo2-dev pkg-config gir1.2-gtk-3.0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Added pytest-env here to ensure pytest.ini is read correctly
          pip install pytest-env
          pip install -r apps/architect/requirements.txt

      - name: Run Pytest Suite
        env:
          ENV: test # This forces the Config class to use 'test' logic
          OLLAMA_URL: http://localhost:11434
        run: pytest tests/
